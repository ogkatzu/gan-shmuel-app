<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weight System Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Weight System Dashboard</h1>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="unknown-tab" data-bs-toggle="tab" data-bs-target="#unknown" type="button" role="tab">Unknown</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="session-tab" data-bs-toggle="tab" data-bs-target="#session" type="button" role="tab">Session</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="containers-tab" data-bs-toggle="tab" data-bs-target="#containers" type="button" role="tab">Containers</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transactions</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button" role="tab">Batch Weight</button>
      </li>
      <!-- Weight GET tab -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="weight-tab" data-bs-toggle="tab" data-bs-target="#weight" type="button" role="tab">Weight - GET</button>
      </li>
    </ul>

    <div class="tab-content mt-4">
      <!-- Unknown -->
      <div class="tab-pane fade show active" id="unknown" role="tabpanel">
        <h3>Unknown Containers</h3>
        <pre id="unknownResult">Loading...</pre>
      </div>

      <!-- Session -->
      <div class="tab-pane fade" id="session" role="tabpanel">
        <h3>Get Session Info</h3>
        <div class="mb-3">
          <label for="sessionId" class="form-label">Session ID:</label>
          <input type="number" class="form-control" id="sessionId" />
          <button class="btn btn-primary mt-2" onclick="fetchSession()">Fetch</button>
        </div>
        <pre id="sessionResult">Enter session ID and click fetch</pre>
      </div>

      <!-- Containers -->
      <div class="tab-pane fade" id="containers" role="tabpanel">
        <h3>Registered Containers</h3>
        <p id="containersCount"></p>
        <div class="table-container">
          <table class="table table-bordered table-striped" id="containersTable">
            <thead>
              <tr>
                <th>Container ID</th>
                <th>Weight</th>
                <th>Unit</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Transactions -->
      <div class="tab-pane fade" id="transactions" role="tabpanel">
        <h3>All Transactions</h3>
        <p id="transactionsCount"></p>
        <div class="table-container">
          <table class="table table-bordered table-striped" id="transactionsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>DateTime</th>
                <th>Direction</th>
                <th>Truck</th>
                <th>Containers</th>
                <th>Bruto</th>
                <th>Truck Tara</th>
                <th>Neto</th>
                <th>Produce</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Batch Weight -->
      <div class="tab-pane fade" id="batch" role="tabpanel">
        <h3>Batch Weight Upload</h3>
        <form id="batchWeightForm">
          <div class="mb-3">
            <label for="filename" class="form-label">Filename (inside 'in' folder):</label>
            <input type="text" class="form-control" id="filename" name="filename" placeholder="example.csv or data.json" required />
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div class="mt-3">
          <pre id="batchWeightResult"></pre>
        </div>
      </div>

      <!-- Weight GET -->
      <div class="tab-pane fade" id="weight" role="tabpanel">
        <h3>GET /weight</h3>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="weightFrom" class="form-label">From:</label>
            <input type="text" id="weightFrom" class="form-control" placeholder="e.g., 2024-01-01" />
          </div>
          <div class="col-md-4">
            <label for="weightTo" class="form-label">To:</label>
            <input type="text" id="weightTo" class="form-control" placeholder="e.g., 2024-01-31" />
          </div>
          <div class="col-md-4">
            <label for="weightFilter" class="form-label">Filter:</label>
            <input type="text" id="weightFilter" class="form-control" placeholder="e.g., valid" />
          </div>
        </div>
        <button class="btn btn-success mb-3" onclick="fetchWeight()">Fetch Weight</button>
        <pre id="weightResult">Enter parameters and click fetch</pre>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Load unknown containers
    fetch("/unknown")
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("unknownResult").textContent = JSON.stringify(data, null, 2);
      });

    // Fetch session info
    function fetchSession() {
      const id = document.getElementById("sessionId").value;
      if (!id) return;

      fetch(`/session/${id}`)
        .then((res) => res.json())
        .then((data) => {
          document.getElementById("sessionResult").textContent = JSON.stringify(data, null, 2);
        })
        .catch((err) => {
          document.getElementById("sessionResult").textContent = "Error fetching session";
        });
    }

    // Load containers
    fetch("/containers")
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("containersCount").textContent = `Total containers: ${data.count}`;
        const tbody = document.querySelector("#containersTable tbody");
        tbody.innerHTML = "";
        data.containers.forEach((c) => {
          const row = `<tr>
            <td>${c.container_id}</td>
            <td>${c.weight}</td>
            <td>${c.unit}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });

    // Load transactions
    fetch("/transactions")
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("transactionsCount").textContent = `Total transactions: ${data.count}`;
        const tbody = document.querySelector("#transactionsTable tbody");
        tbody.innerHTML = "";
        data.transactions.forEach((t) => {
          const row = `<tr>
            <td>${t.id}</td>
            <td>${t.datetime}</td>
            <td>${t.direction}</td>
            <td>${t.truck}</td>
            <td>${t.containers}</td>
            <td>${t.bruto}</td>
            <td>${t.truckTara ?? ""}</td>
            <td>${t.neto ?? ""}</td>
            <td>${t.produce}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });

    // Batch weight
    document.getElementById("batchWeightForm").addEventListener("submit", async function (event) {
      event.preventDefault();
      const filename = document.getElementById("filename").value;

      const response = await fetch("/batch-weight", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ file: filename }),
      });

      const result = await response.json();
      document.getElementById("batchWeightResult").textContent = JSON.stringify(result, null, 2);
    });

    // Fetch weight with GET parameters
    function fetchWeight() {
      const from = document.getElementById("weightFrom").value;
      const to = document.getElementById("weightTo").value;
      const filter = document.getElementById("weightFilter").value;

      const query = new URLSearchParams();
      if (from) query.append("from", from);
      if (to) query.append("to", to);
      if (filter) query.append("filter", filter);

      fetch(`/weight?${query.toString()}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("weightResult").textContent = JSON.stringify(data, null, 2);
        })
        .catch(err => {
          document.getElementById("weightResult").textContent = "Error fetching weight data";
        });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
